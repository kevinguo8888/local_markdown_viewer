# LAD-IMPL-013 安全规则说明（本仓库实现摘要）

> 版本：v1.0（针对 local_markdown_viewer_app 实际实现）  
> 关联任务：LAD-IMPL-013 链接处理安全（S06）

---

## 1. 配置来源与默认示例

本仓库中，013 相关安全策略主要来自以下配置文件：

- `config/features/security.json`
- `config/features/link_processing.json`

### 1.1 `config/features/security.json`

当前示例内容（简化摘录）：

```json
{
  "allowed_protocols": ["https", "mailto"],
  "allowed_domains": ["example.com"],
  "forbidden_patterns": [],
  "windows_specific": {
    "drive_letters": [],
    "max_path_depth": 32
  }
}
```

含义：

- **协议白名单**：`allowed_protocols`
  - 目前允许 `https`、`mailto`。
- **域名白名单**：`allowed_domains`
  - 目前仅允许 `example.com`。
- **路径禁止模式**：`forbidden_patterns`
  - 默认空列表，可按需配置如 `".."`、特定子路径等。
- **Windows 专项限制**：`windows_specific`
  - `drive_letters`: 如非空，则只允许列表中的盘符；
  - `max_path_depth`: 最大路径深度，超过时视为不安全。

### 1.2 `config/features/link_processing.json`

当前示例内容（简化摘录）：

```json
{
  "enabled": true,
  "check_exists": true,
  "external_links": true,
  "image_links": true,
  "mermaid_links": true,
  "file_protocol": true,
  "cache_enabled": true,
  "cache_size": 1000,
  "error_handling": "strict",
  "windows_specific": {},
  "security": {},
  "logging": { "json": false }
}
```

说明：

- `check_exists`:
  - 为 `true` 时，对本地路径进行存在性检测（找不到则返回 `NOT_FOUND`）。
- `security` 段：
  - 如存在，将与 `features/security.json` 合并或覆盖，作为链接验证的最终策略来源之一。
- 其他字段（`external_links`、`file_protocol` 等）
  - 控制是否启用对应类型链接的处理逻辑，与 013 的安全规则配合作用。

---

## 2. LinkValidator 安全校验规则

核心实现见：`core/link_processor.py` 中的 `LinkValidator.validate`。

### 2.1 URL 安全校验（协议 / 域名）

对于 `str` 类型的目标（通常是 URL 字符串），行为如下：

1. 使用 `urlparse` 解析链接。
2. 如存在 `scheme`：
   - 从策略中读取：`security.allowed_protocols`、`security.allowed_domains`。
   - **协议白名单**：
     - 若配置了 `allowed_protocols`，且当前 `scheme` 不在其中，则：
       - 返回：`ok=False`，`error_code=SECURITY_BLOCKED`，`message="protocol not allowed"`。
   - **域名白名单（fail-closed 行为）**：
     - 当 `scheme` 为 `http` 或 `https` 时：
       - 读取 `allowed_domains`；
       - 若 `allowed_domains` 为空或未配置，**默认拒绝所有外链**；
       - 若当前域名（`netloc`）不在白名单中：
         - 返回：`ok=False`，`error_code=SECURITY_BLOCKED`，`message="domain not allowed"`；
       - 仅在协议和域名同时满足白名单时才返回 `ok=True`。

**示例行为：**

- 配置：
  - `allowed_protocols = ["https"]`
  - `allowed_domains = ["example.com"]`
- 链接：
  - `https://example.com/page` → 通过（`ok=True`）。
  - `http://example.com/page` → 协议不在白名单，被拒绝（`SECURITY_BLOCKED`）。
  - `https://other.com/page` → 域名不在白名单，被拒绝（`SECURITY_BLOCKED`）。
  - `https://example.com` 且 `allowed_domains = []` → 触发 fail-closed，被拒绝（`SECURITY_BLOCKED`）。

### 2.2 路径安全校验（本地 Path）

对于 `Path` 类型的目标（本地文件或目录路径），行为如下：

1. 记录原始字符串：`original_path_str = str(resolved)`。
2. **禁止模式检查**：
   - 从策略读取：`security.forbidden_patterns`（列表）。
   - 若任一模式 `pat` 出现在 `original_path_str` 中：
     - 返回：`ok=False`，`error_code=SECURITY_BLOCKED`，`message="forbidden pattern"`，并在 details 中记录匹配的 `pattern`。
3. 对路径进行标准化：`os.path.normpath(original_path_str)`。
4. **最大深度限制**：
   - 从 `windows_specific.max_path_depth` 读取最大层级数；
   - 使用 `Path(...).parts` 计算除盘符外的层数；
   - 若层数超出阈值：
     - 返回：`ok=False`，`error_code=SECURITY_BLOCKED`，`message="max depth exceeded"`。
5. **盘符白名单**（Windows）：
   - 从 `windows_specific.drive_letters` 读取允许的盘符列表；
   - 若配置非空，且当前路径盘符不在列表中：
     - 返回：`ok=False`，`error_code=SECURITY_BLOCKED`，`message="drive not allowed"`。
6. **存在性检查**：
   - 当 `policy.check_exists` 为 `True`（默认）时：
     - 若目标路径不存在，则：
       - 返回：`ok=False`，`error_code=NOT_FOUND`，`message="path not found"`。
7. **可选 ACL 检查**：
   - 当 `policy.check_acl` 为 `True` 时：
     - 使用 `os.access(..., os.R_OK)` 检查可读权限，不可读时返回 `PERMISSION_DENIED`。

总结：

- 任何一步触发安全限制时，都返回 `ok=False` 且带有对应的 `ErrorCode`；
- 未触发安全/存在性问题时，返回 `ok=True`。

---

## 3. LinkProcessor 与安全规则的联动

核心实现见：`core/link_processor.py` 中的 `LinkProcessor.process_link`。

### 3.1 外链（EXTERNAL_HTTP）

- 对 `http://` / `https://` 链接，`LinkTypeRecognizer` 将其识别为 `LinkType.EXTERNAL_HTTP`。
- `LinkProcessor` 在处理外链时：
  - 使用 `LinkValidator.validate` 结合当前策略（`features/link_processing.json` 与 `features/security.json` 的合并结果）进行安全检查；
  - 当 `validate` 返回 `ok=False` 且 `error_code=SECURITY_BLOCKED` 时：
    - 返回 `LinkResult(success=False, action="show_error", error_code=ErrorCode.SECURITY_BLOCKED, ...)`；
    - 从而在 UI 层表现为“安全拦截”（而不是静默失败）。
  - 当校验通过时：
    - 通过 `ExternalHandler` 返回 `action="open_browser"` 等行为，实际打开外部浏览器。

当前仓库已有的测试用例（位于 `tests/test_link_processor.py` 中）：

- `test_external_link_blocked_by_default_fail_closed_lp`
  - 验证：在缺少显式白名单时，外链默认被拦截（fail-closed），并返回 `SECURITY_BLOCKED` + `action="show_error"`。

### 3.2 本地路径与目录

- 对本地 `Path`（相对或绝对路径），`LinkProcessor` 通过 `PathResolver` 解析后：
  - 在执行文件/目录相关动作前，同样调用 `LinkValidator.validate`；
  - 当路径命中 `forbidden_patterns`、超出 `max_path_depth`、盘符不在白名单、或不存在时：
    - 返回对应错误码（`SECURITY_BLOCKED` 或 `NOT_FOUND`），并统一以 `action="show_error"` 告知上层。

---

## 4. 013 专用测试入口：tests/test_link_security_rules.py

为便于在 013 阶段做“安全规则专项验收”，本仓库增加了轻量级测试入口：

- 文件：`tests/test_link_security_rules.py`
- 特点：
  - 使用环境变量门控：仅在 `LAD_RUN_013_TESTS=1` 时运行；
  - 聚焦于：
    - 协议/域名白名单与 fail-closed 行为；
    - 路径禁止模式、深度限制和盘符限制的代表性场景；
  - 不重复实现复杂逻辑，仅对现有 `LinkValidator` 行为做可读性更高的验收封装。

配合已有测试：

- `tests/test_link_processor.py` 中已经覆盖：
  - 外链放行与拦截行为（包括 `SECURITY_BLOCKED` → `show_error`）；
  - 路径安全与存在性检查；
  - 快照记录中的错误码与动作信息。

`test_link_security_rules.py` 主要作为 013 的“专门安全验证入口”，便于在需要时单独启用一组安全相关用例。

---

## 5. 验收与使用建议

- **验收建议**：
  - 在 013 阶段：
    - 设置 `LAD_RUN_013_TESTS=1`，运行 `pytest tests/test_link_security_rules.py`；
    - 同时运行 `tests/test_link_processor.py` 中已有用例，确保链路行为与安全规则一致；
  - 结合 `docs/013-前置与并行计划.md` 中的执行步骤与验收标准，完成 013 收尾。

- **配置调整建议**：
  - 修改 `features/security.json` 或 `features/link_processing.json` 时：
    - 优先在本文件记录的规则框架内调整；
    - 尽量保持“外链 fail-closed、本地路径显式受控”的设计原则；
    - 每次调整后，建议重新运行安全相关测试用例，避免放宽策略导致意外回归。
