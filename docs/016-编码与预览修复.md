# 016: 编码与预览修复专题（规划草案）

**文档版本**: V0.1-draft  
**适用范围**: local_markdown_viewer_app 当前仓库  
**任务类型**: Bug 修复 / 体验优化（编码与文件预览）  
**关联模块**: `core/content_preview.py`, `ui/content_viewer.py`  
**不直接关联模块**: `core/link_processor.py` 及 012–015 链接处理主线

> 本文档用于记录并规划“非 Markdown 文件预览出现乱码”的问题及后续修复路径，
> 当前阶段仅为**问题与方案规划**，不代表本仓库已完成修复。

---

## 1. 问题描述与重现

### 1.1 问题现象

- 在应用中预览以下类型的文件时（通过 ContentViewer 打开）：
  - JavaScript 文件，如：`universal-session-timestamp.js`
  - JSON 文件，如：`vscode-session-id-snippet.json`
  - 以及部分 Python 文件，如：`lad_system_launcher.py`
- 日志中可见 `core.content_preview` 输出的编码信息类似：
  - `encoding=Windows-1254` 或 `encoding=ascii`
- 实际文件内容为 UTF-8 编码且包含中文注释或文案，
  - 在 UI 中渲染结果出现典型“乱码”（中文部分出现错位或不可读字符）。

### 1.2 重现条件（示意）

> 以下为典型重现场景的抽象描述，具体路径以本地实际项目为准：

1. 启动本地应用（`main.py` 或集成窗口入口）。  
2. 在侧边栏或文件列表中选择一个 JS/JSON/PY 文件（含中文注释，UTF-8 编码）。  
3. 通过 ContentViewer 打开该文件：
   - 日志中记录：`ContentPreview`/`ContentViewer` 加载文件成功；
   - 日志中记录使用的 `encoding` 为 `Windows-1254`/`ascii` 等；
   - UI 中正文区域显示严重乱码。  
4. 对比同一文件在 VS Code 或其他编辑器中的显示（正常的 UTF-8 中文）。

### 1.3 影响范围初步判断

- **受影响的功能**：
  - 代码/配置类文件（JS/JSON/PY 等）的**预览内容显示**。
- **暂未发现受影响的功能**：
  - Markdown 文件正文渲染（含中文）目前表现正常；
  - 012–015 链接处理主线：
    - 链接识别与路由；
    - 链接点击体验（LPCLICK + `acceptNavigationRequest`）；
    - 013/014 相关安全规则与体验用例；
  - 因此该问题**不构成 012–015 的回归**，属于独立的编码/预览体验缺陷。

---

## 2. 范围界定与目标

### 2.1 问题范围（Scope）

- **属于本专题的内容**：
  - `ContentPreview` 在读取文件内容时的编码探测与解码逻辑；
  - `ContentViewer` 在展示代码/配置文件内容时对编码信息的使用；
  - 针对常见文件类型（JS/JSON/PY 等）的编码策略优化；
  - 针对包含中文内容的文件预览，提供稳定、可预期的显示结果。

- **不属于本专题的内容**：
  - 链接处理安全策略（013）、体验修正（014）、诊断规划（015）的逻辑修改；
  - Markdown 渲染引擎的语法高亮、样式等问题（除非直接由编码导致）。

### 2.2 修复目标

1. **正确显示 UTF-8 中文内容**  
   - 对于 UTF-8 编码、包含中文注释/文案的 JS/JSON/PY 文件，
     - ContentPreview 应以正确编码解码；
     - UI 展示中不出现乱码。

2. **统一、可解释的编码策略**  
   - 建立明确的编码优先级策略，例如：
     1. 文件内显式声明的编码（如 `# -*- coding: utf-8 -*-`）；
     2. 默认 UTF-8；
     3. 必要时的自动检测或系统默认编码；
   - 对于超出能力范围的文件（编码不明或损坏），给出清晰的错误提示，而不是静默乱码。

3. **最小化对现有逻辑的影响**  
   - 不改变 Markdown / 链接处理链路的现有行为；
   - 不引入重型依赖（如大型编码检测库），除非明确可选。

---

## 3. 根因猜测与待确认点

> 本节为初步分析，实际实现前需要结合代码与日志进一步验证。

### 3.1 可能的根因方向

- **[R1] 自动编码检测误判**  
  - ContentPreview 可能内部使用某种自动编码探测逻辑，
    - 在特定内容特征下误判为 `Windows-1254` 或纯 `ascii`；
    - 导致对 UTF-8 文件以错误编码解码，出现乱码。

- **[R2] 平台默认编码干扰**  
  - 在 Windows 环境下，若未显式指定 `encoding`，
    - 文件 I/O 或某些第三方库可能回退到系统默认编码；
    - 与文件实际编码（UTF-8）不一致时引发乱码。

- **[R3] 多层组件之间的编码信息丢失/覆盖**  
  - ContentPreview 与 ContentViewer 之间可能传递 `encoding` 信息；
  - 如果中间存在“二次解码”或字符串被当作 bytes 再次处理，
    - 也有可能引起乱码。

### 3.2 需要在代码级确认的点

- ContentPreview 在读取文件时：
  - 是否有统一的 `open(..., encoding=...)` 策略；
  - 是否通过 BOM / chardet 等方式进行猜测；
  - 是否针对不同扩展名（.md / .js / .json / .py）采用不同逻辑。

- ContentViewer 在接收/展示文本时：
  - 是否对文本再次进行编码/解码处理；
  - 是否依赖 Qt/WebView 的默认编码设置。

---

## 4. 修复策略草案

> 本节只是修复思路规划，当前仓库未实施。

### 4.1 编码策略设计

建议在 ContentPreview 中统一采用以下优先级策略：

1. **显式编码声明优先**  
   - 对 Python 等文件，若首行/前几行包含 `coding: utf-8` 或类似注释，优先使用该编码。

2. **默认 UTF-8**  
   - 对于无显式声明但在本项目中通常使用 UTF-8 的文件类型（MD/JS/JSON/PY 等），
     - 默认按 UTF-8 解码；
     - 若解码失败（`UnicodeDecodeError`），再考虑降级策略。

3. **可选的自动探测/系统编码兜底**  
   - 对于确实不是 UTF-8 或声明不清的文件，
     - 可以尝试轻量级自动检测（如基于 BOM 或简单启发式）；
     - 或退回系统默认编码，但需在 UI 中给出明显提示（例如“可能存在编码不一致”）。

### 4.2 日志与错误提示

- 在 ContentPreview 中：
  - 当发生编码降级或自动探测时，记录详细日志：
    - 文件路径、初始尝试编码、降级原因、最终采用编码；

- 在 UI 中：
  - 对于无法可靠解码的文件，避免展示“乱码文本”；
  - 可以显示一段说明，例如“当前文件编码无法识别，请在外部编辑器中查看或手动指定编码”。

### 4.3 渐进式实现建议

1. **阶段 1：观察与日志增强**  
   - 在不改变行为的前提下，增加对当前编码检测/解码路径的日志；
   - 使用少量带中文的样例文件进行手工验证。

2. **阶段 2：引入统一 UTF-8 优先策略**  
   - 对 MD/JS/JSON/PY 等常见文本类型尝试统一采用 UTF-8 为首选；
   - 确认不会对现有 Markdown 渲染与链接处理产生负面影响。

3. **阶段 3：补充自动探测与错误提示**  
   - 在确需处理多编码文件的前提下，增加合理的探测与错误提示机制；
   - 保持实现简单且可测试。

---

## 5. 测试与验证规划

> 以下为未来实现该专题修复时，建议补充的测试点。

### 5.1 单元测试建议

- 为 ContentPreview 新增或补充测试用例：
  - 加载 UTF-8 中文 JS 文件，预期无乱码；
  - 加载 UTF-8 中文 JSON 配置文件，预期无乱码；
  - 加载包含编码声明的 Python 文件，优先使用声明编码；
  - 加载故意破坏的编码文件，验证错误提示与日志记录。

### 5.2 集成/手工验证

- 在实际应用界面中完成以下操作：
  - 打开多种类型文件（MD/JS/JSON/PY），观察中文显示是否正常；
  - 对比修复前后的日志，确认编码判断逻辑变化符合预期；
  - 关注 UI 中错误提示是否清晰、不会干扰正常使用。

---

## 6. 与其他任务的关系

- **与 012–015 链接处理任务线**：
  - 本专题为独立的编码/预览体验问题，不改变 012–015 已完成功能；
  - 可在 012–015 链路“暂时封盘”的前提下独立推进，不影响对链接处理任务阶段性的关闭判断。

- **与未来的观察性/诊断任务（015 等）**：
  - 编码与预览行为的稳定性，有助于未来诊断报告与调试体验；
  - 但本专题不依赖 015 的诊断引擎实现，可以单独排期。

---

## 7. 当前仓库状态说明

- 本文档 `docs/016-编码与预览修复.md` 已落盘，
  - 记录了问题现象、影响范围、根因猜测与修复/测试规划；
  - 明确该问题不属于 012–015 功能主线，而是独立的体验与质量问题。
- **尚未完成的部分**：
  - 未对 ContentPreview / ContentViewer 的编码实现做任何修改；
  - 未新增编码相关测试用例；
  - 未在 execution_checklist 中增加 016 对应的条目。

未来若需要推进该专题，可基于本规划：
- 在 docs/execution_checklist_012_015.json 之外，新建或扩展后续阶段的 checklist；
- 按 4/5 章所述步骤，逐步实现编码策略与相关测试。
