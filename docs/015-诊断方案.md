# 015 自动化诊断 - 前置条件与执行路径规划草案

**文档版本**: V0.1-draft  
**适用范围**: local_markdown_viewer_app 当前仓库  
**关联任务**: LAD-IMPL-015 自动化诊断（仅规划，不含实现）  
**上游文档**: `docs/LAD-IMPL-015-自动化诊断-任务提示词.md`  

> 本文档的目标是：
> - 在不实现 015 任何诊断逻辑的前提下，固化一份「前置条件与最小执行路径」规划草案；
> - 为未来实现留出清晰的挂载点（脚本骨架函数 / 配置项 / 报告结构），避免遗忘；
> - 明确本仓库当前停留在“规划已落盘，诊断未实装”的状态，方便后续人员快速恢复上下文。

---

## 1. 文档目的与边界

1. **仅做规划，不做实现**
   - 不在本仓库内接入新的诊断引擎或规则引擎；
   - 不修改现有的 `core/link_processor.py`、`core/debug_diagnostics_manager.py` 等核心模块逻辑；
   - 不新增任何定时任务、守护进程或外部依赖。

2. **聚焦链接处理相关的 015 子集**
   - 全量 LAD-IMPL-015 涵盖系统健康、性能、链接处理等多个模块；
   - 本仓库当前只针对「链接处理诊断」这一子集做规划草案，其他模块视为未来任务；
   - 与 012–014 链接处理主线保持解耦：**015 规划不回写、不修改现有链接处理实现**。

3. **与既有文档/清单的关系**
   - 上游任务说明：`docs/LAD-IMPL-015-自动化诊断-任务提示词.md`
   - 执行清单项：`docs/execution_checklist_012_015.json` 中的 `S09`（Diagnostics integration for link processing），状态仍为 `pending`；
   - 本文档只满足 S09 的「规划/草案已存在」这一前置，不代表 S09 已完成。

---

## 2. 前置条件检查规划

本节只定义「应该检查什么」以及「目标状态」，**不在本仓库实现实际检查逻辑**。未来实现可参考本节，将检查逻辑写入诊断脚本或 DiagnosticsManager。

### 2.1 配置类前置条件

- **[P1] 诊断配置入口存在**  
  - 期望位置：
    - 首选：`config/features/diagnostics.json`
    - 兜底：`app_config.json` 下的 `diagnostics` 段落
  - 目标：
    - 至少存在一个可解析的 JSON 源；
    - 包含 `diagnostics.global.enabled` 与 `diagnostics.modules` 基本结构；
  - 规划中的检查思路：
    - 仅做“文件存在 + JSON 结构可解析”的轻量检查；
    - 不强依赖具体字段值的正确性（留给后续规则引擎）。

- **[P2] 链接处理配置可用**  
  - 关联文件：
    - `config/features/link_processing.json`
    - `config/features/security.json`
  - 目标：
    - 链接处理配置存在，且可以被 `ConfigManager` 正常读取；
    - 安全策略段落（如 `allowed_protocols` / `allowed_domains` / `forbidden_patterns` 等）可解析；
  - 规划检查要点：
    - 不做“策略是否合理”的判断，只验证结构与类型基本合理。

- **[P3] 性能阈值配置可用**  
  - 关联文件：`config/runtime/performance.json`（或等价路径）  
  - 目标：诊断规划中可以引用性能阈值（例如响应时间上限），但不强制当前仓库已经严格对齐。

### 2.2 依赖组件前置条件

- **[P4] 性能监控组件就绪（LAD-IMPL-011）**  
  - 目标：
    - `core/performance_metrics.py` 存在，且在单元测试中已被基本验证；
    - 与性能阈值配置的最小对齐（字段名、类型）在未来诊断中可被利用。

- **[P5] 链接处理主链路畅通（LAD-IMPL-012/014）**  
  - 目标：
    - `core/link_processor.py` 工作正常，LPCLICK 链路（`ui/content_viewer.py` → `LinkProcessor.process_link`）在 012–014 中已完成并通过测试；
    - 013/014 相关测试与安全规则文档已落盘，可作为诊断输入的一部分。

- **[P6] 调试与诊断基础设施存在**  
  - 关联模块：`core/debug_diagnostics_manager.py` 及其测试用例  
  - 目标：
    - DebugDiagnosticsManager 可以在独立环境中运行系统/应用/性能等基础诊断；
    - 后续链接处理诊断可以复用该管理器作为“诊断结果收集与落盘”的统一入口之一。

### 2.3 运行环境与安全前置

- **[P7] 运行环境约束**  
  - Python 版本、操作系统、权限等满足 DebugDiagnosticsManager 与现有测试运行要求；
  - 诊断脚本应尽量以“只读”方式访问配置和日志，不做破坏性修改。

- **[P8] 与现有测试/CI 的关系**  
  - 诊断脚本不应成为 pytest 的强制前置条件；
  - 可以在 CI 或本地脚本中作为“可选步骤”运行（例如：手动触发、单独作业）。

---

## 3. 最小执行路径草案

本节描述未来诊断脚本（例如 `diagnostics/link_processing_diagnostics_draft.py`）**理想中的执行流程**。当前仓库仅创建脚本骨架，并打印规划信息，不执行实际诊断。

### 3.1 顶层流程概览

建议的最小执行路径分为四个阶段：

1. **收集规划信息（plan-only 模式）**
   - 读取并返回一份“诊断执行计划”的结构化描述（JSON）；
   - 列出将要检查的配置文件、模块和检查项 ID；
   - 不访问文件系统、不调用外部依赖。

2. **前置条件自检（preflight checks）**
   - 可选阶段；在未来实现中：
     - 尝试以只读方式检查 P1–P6 中列出的配置与模块是否存在；
     - 将检查结果写入诊断报告的 `preflight` 段落；
   - 本仓库当前仅预留函数签名与返回结构，不执行真实检查。

3. **链接处理上下文收集（context aggregation）**
   - 规划未来可能收集的信息：
     - 链接处理相关配置（link_processing/security）当前值；
     - 与链接安全相关的测试结果概要（例如 013 专用安全用例是否通过）；
     - 链接处理相关日志的统计摘要（如错误率、SECURITY_BLOCKED 比例等）。
   - 当前仅在规划中说明，不在本仓库实现。

4. **生成诊断报告草案（report draft）**
   - 报告应是**机器可读**（JSON）且**人可读**（文本/Markdown）的；
   - 至少分为：`preflight`、`link_processing`、`performance` 三个大段；
   - 本仓库阶段仅在脚本骨架中返回一份“计划模板”，不生成实际报告文件。

### 3.2 与脚本骨架的映射

为方便未来实现，建议在 `diagnostics/link_processing_diagnostics_draft.py` 中预留如下函数（本仓库已创建骨架）：

- `build_plan_summary() -> Dict[str, Any]`
  - 返回一份包含版本、相关文档路径、阶段列表的计划摘要；
  - 当前实现仅返回静态结构，不访问磁盘。

- `run_preflight_checks() -> Dict[str, Any]`
  - 未来承载 P1–P6 的实际检查逻辑；
  - 当前实现返回 `{"status": "draft_only"}` 等占位字段，提示“未实装”。

- `run_link_processing_diagnostics() -> Dict[str, Any]`
  - 未来承载针对链接处理模块的专用诊断（配置一致性、安全策略覆盖、性能指标等）；
  - 当前实现同样仅返回占位结果。

- `main(argv: Optional[List[str]] = None) -> int`
  - 提供命令行入口，支持：
    - `--plan-only` / `--dry-run`：仅输出规划 JSON 与说明文字；
    - 默认行为与 `--plan-only` 等价，**不执行任何真实诊断**；
  - 退出码始终为 0，表示“脚本正常运行，但诊断尚未实现”。

### 3.3 运行示意（规划阶段）

> 以下为未来可能的调用方式示例，当前仅用于说明：

```bash
python -m diagnostics.link_processing_diagnostics_draft --plan-only
```

- 预期输出：
  - 一段 JSON，描述诊断计划的版本、阶段、相关文档；
  - 一段说明文字，明确“当前仅为规划草案，未执行真实诊断”。

---

## 4. 报告与集成的预期形态

本节仅描述未来期望的诊断输出与集成方式，不在本仓库实现。

### 4.1 报告结构草案

建议未来的诊断报告（例如 `diagnostics/link_processing_diagnostics.json`）包含以下顶层字段：

- `version`: 诊断方案版本号（例如 `"0.1-draft"` → `"1.0"`）；
- `generated_at`: 生成时间戳；
- `preflight`: 前置条件检查结果摘要；
- `link_processing`: 链接处理相关诊断详情；
- `performance`: 与链接处理相关的性能诊断摘要；
- `recommendations`: 综合修复建议列表。

### 4.2 与 DebugDiagnosticsManager 的关系

- DebugDiagnosticsManager 已经提供了系统/应用/性能等通用诊断能力；
- 未来可以通过以下方式集成链接处理诊断：
  - 在 DebugDiagnosticsManager 中增加一个 `link_processing` 相关的组件状态；
  - 或由本脚本调用 DebugDiagnosticsManager 的部分接口，将结果纳入统一报告；
- 本仓库阶段**不对 DebugDiagnosticsManager 做任何修改**，仅在规划中预留该可能性。

---

## 5. 当前仓库的完成状态说明

1. **已完成**
   - 015 上游任务提示词已存在：`docs/LAD-IMPL-015-自动化诊断-任务提示词.md`；
   - 本文档 `docs/015-诊断方案.md` 已落盘，固化了：
     - 前置条件（P1–P8）的规划；
     - 最小执行路径（plan-only → preflight → context → report）的草案；
     - 与脚本骨架的函数映射关系；
   - 最小诊断脚本骨架已创建（位于 `diagnostics/` 目录），当前仅输出规划信息，不执行诊断。

2. **未完成 / 留待未来的部分**
   - 015 诊断引擎与规则实现；
   - 与 CI / 监控系统的真实集成（定时任务、告警链路等）；
   - 链接处理诊断的具体规则、指标与报告格式的细化；
   - 扩展测试用例（例如 `tests/test_link_processing_diagnostics.py`）以覆盖真实诊断逻辑。

3. **重要说明**
   - 在本仓库中，LAD-IMPL-015 仅停留在“规划草案已落盘”的阶段；
   - execution_checklist 中与 015 相关的步骤仍保持 `pending`，以便未来实现时重新打开；
   - 本文档与脚本骨架的主要价值是：**帮助未来的自己或其他维护者快速恢复上下文，并基于统一的前置条件与执行路径继续推进 015**。
