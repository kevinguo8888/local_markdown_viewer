# LAD-IMPL-013 前置与并行计划 v1.0

- 目标：固化 013（安全）任务的前置条件、并行任务与验收路径，最小化回归风险。
- 关联版本：012 已验收；012A 测试门控已就绪。

## 一、前置条件（必须满足后再开展 013 正式实现/验收）
- features 配置示例已提供并可读取（路径：`config/features/`）
  - `security.json`
    - 关键键：`allowed_protocols`、`allowed_domains`、`forbidden_patterns`、`windows_specific.{drive_letters,max_path_depth}`
    - 初始示例：`{"allowed_protocols":["https"],"allowed_domains":["example.com"]}`
  - `link_processing.json`
    - 关键键：`check_exists`、`external_links`、`file_protocol`、`windows_specific`、`security`（可覆盖/补充）
- 测试门控已启用（避免生产注释注入）
  - ContentViewer 仅在 `_on_page_load_finished()` 通过 `runJavaScript` 注入拦截脚本
  - `_display_html()` 的 `<!-- link_handling -->` 注释仅在测试模式或配置开关开启时注入：
    - 环境变量触发：`LAD_TEST_MODE=1` 或存在 `PYTEST_CURRENT_TEST`/`PYTEST_PROGRESS_LOG`
    - 配置触发：`ui.content_viewer.link_marker_injection_for_test=true`
- 配置读取链路校验
  - `ConfigManager.get_unified_config('features.security')`、`('features.link_processing')` 能返回有效对象
  - `LinkProcessor` 加载策略优先级：`app.link_processing` → `features.link_processing`；`security` 优先 `features.security` → `app.security`

## 二、并行任务排期
- t1（已完成，high）
  - 范围：
    - URL 校验（协议/域名白名单，fail-closed 行为）
    - 相对路径/锚点/file:// 解析
    - `check_exists`=true 的存在性校验
    - 各 `LinkType` 动作路由正确性
  - 交付物：`tests/test_link_processor_*.py` 系列用例（按主题拆分）
- fix_tests3（已完成，high，绑定到 013 初期）
  - 目标：通过 `config/test_config_manager.py` 两项基础用例（app_config 存在性、缓存首次访问）
  - 策略：核对默认加载/创建逻辑与 `get_unified_config('app')` 语义
- fix_tests4（已完成，medium，绑定到 015 阶段）
  - 目标：为 SnapshotManager 增加最小桩或保护策略，通过 thread_safety 系列测试
  - 备注：与 015（诊断/并发）主线更契合，可在 015 启动时并行推进

## 三、执行步骤（建议）
1) 校验 features 配置被正确加载（打印/断言关键键）
2) 安全策略演示：
   - `allowed_domains` 含 `example.com` 时，https://example.com 应放行
   - 清空/不含域名时，外链默认拦截（`SECURITY_BLOCKED` + `action=show_error`）
3) 日志与错误码联动校验：确认拦截/放行时的日志结构化字段与错误码一致
4) 运行 t1 目标用例，补齐缺口后合入主分支
5) 013 阶段性验收后，切入 fix_tests3（基础用例修复）

## 四、验收标准（013）
- 策略可通过 features 配置切换放行/拦截（即改即生效）
- 外链校验行为为 fail-closed，未配置域名即拦截
- 目标用例通过：t1 集合 + 既有与安全相关的集成用例
- 日志/错误码一致：出现安全拦截时包含 `SECURITY_BLOCKED` 与 `action=show_error`

## 五、风险与缓解
- 过度拦截：提供最小可用示例与说明，引导显式放行
- 平台差异（Windows 路径/驱动器）：通过 `windows_specific` 分支控制（驱动器、深度）
- 回归噪声：t1 与 fix_tests3 分批推进，避免一次性改动过大

## 六、追踪与里程碑
- TODO 追踪：
  - t1（completed, high）
  - fix_tests3（completed, high → 013 初期）
  - fix_tests4（completed, medium → 015 阶段）
- 里程碑：
  - M1：features 配置验证完成
  - M2：t1 初版合入，013 中期验收
  - M3：fix_tests3 完成，013 收尾
  - M4：015 启动，fix_tests4 合入

## 七、变更与测试结果摘要
 - **代码变更**
   - ConfigManager.get_config 增加向后兼容键支持：`app_config`、`ui_config`、`file_types_config`、`external_modules`。
   - DynamicModuleImporter 完善函数映射校验；路径导入遇到映射不完整/不可调用/MISSING_SYMBOLS 时直接返回，标记 `function_mapping_status='incomplete'`，避免落入 exhausted 分支。
   - SnapshotManager 新增 `set_cache_manager`，满足并发用例依赖。
   - features/logging.json 新增 `metrics.thresholds` 与快照参数；与 `runtime/performance.json` 阈值对齐（pm1 完成）。
 - **测试结果**
   - 定向用例：`tests/test_function_mapping.py`、`tests/test_thread_safety.py` 全部通过。
   - 全量回归：通过（exit=0）。已清理部分测试警告（return→assert；asyncio.run），仍有若干 `PytestReturnNotNoneWarning` 留作后续低优先级清理项。
 - **安全与回归**
   - 链接处理器维持 fail-closed 外链策略；未配置白名单默认拦截。
   - 变更遵循最小化原则与向后兼容，未检出回归。

## 八、CI/测试门禁：Warnings as Errors
- **规则**
  - 全局启用“警告即失败”：`pytest.ini` 设置 `addopts = -W error`，并 `filterwarnings = error`。
  - 本地脚本 `run_pytests.ps1` 默认追加参数 `-W error`，与 CI 行为一致。
- **适用范围**
  - 覆盖全部测试套件：单元/集成/E2E，包括 `tests/test_qa_all.py` 触发的脚本与二阶段输出用例。
- **环境与日志**
  - 测试环境禁用集成文件日志写入（`integrated.log`），仅输出到控制台：当 `LAD_TEST_MODE=1`、存在 `PYTEST_CURRENT_TEST` 或已加载 `pytest` 模块时生效。
- **开发要求**
  - 测试函数使用断言，不返回 `True/False/对象`（避免 `PytestReturnNotNoneWarning`）。
  - 异步测试使用 `asyncio.run(...)`，避免 `get_event_loop().run_until_complete(...)` 的弃用告警。
  - 关闭未释放的资源/文件句柄/线程，避免资源类告警在 CI 中被升级为错误。
- **验证流程**
  - 先定向（最小集）后全量（-W error），全量必须 0 warning / 0 failure。
- **本地临时放宽（仅调试，不用于 CI）**
  - 可在命令行临时覆盖为 `-W default` 以排查告警；CI 禁止放宽，必须遵循上述门禁。

## 九、013 收尾与补充产物（local_markdown_viewer_app）

- 新增安全规则说明文档：`docs/013-安全规则说明.md`（汇总配置来源与 LinkValidator 规则，面向 013 验收）
- 新增 013 专用安全规则测试入口：`tests/test_link_security_rules.py`（仅在 `LAD_RUN_013_TESTS=1` 时参与运行）
- `docs/execution_checklist_012_015.json` 中的 `S06` 已在本仓库标记为 `completed`，与以上产物对齐.
